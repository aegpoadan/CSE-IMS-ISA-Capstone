<html lang="en">
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"> 
    <title>San Joaquin Valley Town Hall</title>
<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
<link href="styles.css" rel="stylesheet" type="text/css">    
<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
<script>
	var IP = 'ec2-52-10-212-9.us-west-2.compute.amazonaws.com';
	var myID = 0;
	var otherID = 1;
	$.ajaxSetup({
	  xhrFields: {
	    withCredentials: true
	  }
	});
	console.log($.post('http://'+IP+':8080/CapstoneServlet/Capstone/api/login',
			{email: 'frankthetank@gmail.com',
			 password: '1234',
			 xhrFields: {withCredentials: true}
			}
	)
	);
</script>
</head>

<body>
<div data-role="page" id="home">
    <header data-role="header">
        <h1>Team Feed</h1>
        <div data-role="navbar">
		<ul>
			<li><a href="#team1" data-icon="grid" data-theme="b" class="ui-btn-active">Team 1</a></li>
			<li><a href="#team2" data-icon="grid" data-theme="b">Team 2</a></li>
            <li><a href="#team3" data-icon="grid" data-theme="b">Team 3</a></li>
		</ul>
		</div>
    </header>
    
    <section id="content" data-role="content">
       <script>
       		getMessages();
       		function getMessages() {

       			function compareMessages() {
       				return function(a, b) {
       					if( a.timestamp > b.timestamp) {
       						return 1;
       					} else if(a.timestamp < b.timestamp) {
       						return -1;
       					}
       					return 0;
       				}
       			}

				$.get(
				  	'http://'+IP+':8080/CapstoneServlet/Capstone/api/get/messages',
				  	{ 	
				  		limit: '10',
				  		otherID: otherID,
				  		dataType: 'json',
				    	method: 'GET',
				    	xhrFields: {withCredentials: true}
			    	},
			    	function(response) {
			    		var messages = response.messages;
			    		function doContents(posts) {
			    			var allContents = messages.concat(posts).sort(compareMessages());
			    			$.each(allContents,
			    				display(allContents)
			    			);
				    	}
			    		$.get('http://'+IP+':8080/CapstoneServlet/Capstone/api/get/posts',
				    		{
				    			limit:'10',
				    			completed: true,
				    		},
				    		function(response) {
				    			doContents(response.posts);
				    		}
			    		);
					}
			  	);
				setTimeout(getMessages, 2000);
			};

			function display(response) {
				//display feed
				var msgs = document.getElementById('content')
				    		while (msgs.hasChildNodes())
				    			msgs.removeChild(msgs.lastChild);
				$.each(
		   			response,
		   			function(index, value){
		   				console.log(value);
		   				var conv = document.createElement('div');
		   				if('pics' in value) {
		   					conv.appendChild(document.createTextNode("ACE:\n"));
		   					conv.appendChild(document.createElement('br'));
		   					conv.appendChild(document.createTextNode("\t"+value.title+"\n"));
		   					conv.appendChild(document.createElement('br'));
		   					var img = document.createElement("IMG");
		   					img.src = "data:image/png;base64,"+ value.pics[0];
		   					conv.appendChild(img);
		   					conv.appendChild(document.createElement('br'));
		   					conv.appendChild(document.createTextNode("\t"+value.description+"\n"));
		   				} else {
		   					conv.appendChild(document.createTextNode(value.senderName+":\n"));
		   					conv.appendChild(document.createElement('br'));
			   				conv.appendChild(document.createTextNode(value.messageText));
		   				}
		   				conv.appendChild(document.createElement('br'));
		   				conv.appendChild(document.createElement('br'));
		   				msgs.appendChild(conv);
		   			}
	   			);
			};

       </script>
    </section>

    <div>
    <!-- handle user input -->
        <form>
    		<input type="text" id="msgInput">
		</form>
    	<button type="button" onclick="sendMessage()" name="text">Send</button>
    	<script>
    		function sendMessage() {
    			var msg = document.getElementById("msgInput").value;
    			console.log(msg);
    			$.post("http://"+IP+":8080/CapstoneServlet/Capstone/api/post/message",
    			{
    				ToID: otherID,
    				MessageText: msg
    			},
    			function(response) {
    				console.log(response);
    				document.getElementById("msgInput").value="";
    			});
    		};
    	</script>
    </div>
       
    <footer data-role="footer">
        <h4>
        	&copy;&nbsp;
        	<script>
        		var today = new Date();
        		document.write(today.getFullYear());
        		document.write(", 84.51");
        	</script>
        </h4>
    </footer>
</div>

</body>
</html>
